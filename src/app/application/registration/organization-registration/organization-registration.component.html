<div class="org-container">
    <p-toast></p-toast> <!-- Add this to display messages from the MessageService -->
    <p-card class="mb-5">
        <p-tabs value="0">
            <p-tablist>
                <!-- FIX: The header text goes inside the p-tab tag. A 'value' is used to link to the panel. -->
                <p-tab value="0">{{ isEditing ? 'Edit Organization' : 'Add Organization' }}</p-tab>
                <p-tab value="1">View Organizations</p-tab>
            </p-tablist>
            <p-tabpanels>
                <p-tabpanel value="0">
                    <!-- FIX: Wrap the entire input section in a <form> tag -->
                    <!-- The (ngSubmit) event calls your onSubmit() method -->
                    <form #orgForm="ngForm" (ngSubmit)="onSubmit()">
                        <div class="grid p-fluid gap-4">
                            <!-- Is a Group -->
                            <div class="field col-6 md:col-4">
                                <label class="font-bold mb-2 block">Is a Group</label>
                                <div class="flex gap-3 align-items-center">
                                    <p-radioButton name="isGroup" [value]="true" [(ngModel)]="isGroup" inputId="isYes"></p-radioButton>
                                    <label for="isYes">Yes</label>
                                    <p-radioButton name="isGroup" [value]="false" [(ngModel)]="isGroup" inputId="isNo"></p-radioButton>
                                    <label for="isNo">No</label>
                                </div>
                            </div>

                            <!-- Parent Organization -->
                            <div class="field col-6 md:col-4" *ngIf="!isGroup">
                                <label for="parentOrg" class="mb-2 block">Parent Organization</label>
                                <p-dropdown inputId="parentOrg" [options]="parentOrganizations"
                                    [(ngModel)]="selectedParentOrg" placeholder="Select Parent Organization"
                                    optionLabel="name" name="parentOrg" class="w-full"></p-dropdown>
                            </div>

                            <!-- Organization Section -->
                            <div class="col-12">
                                <h5 class="mt-3 mb-2 border-bottom-1 surface-border pb-2 font-semibold text-lg">
                                    Organization Details
                                </h5>
                            </div>

                            <div class="field col-12 md:col-4">
                                <label for="orgName" class="mb-2 block">Organization Name</label>
                                <input id="orgName" type="text" pInputText [(ngModel)]="orgName" name="orgName" class="w-full" required />
                            </div>
                            <div class="field col-12 md:col-3">
                                <label for="brandName" class="mb-2 block">Brand Name</label>
                                <input id="brandName" type="text" pInputText [(ngModel)]="brandName" name="brandName" class="w-full" />
                            </div>
                            <div class="field col-12 md:col-3">
                                <label for="orgUrl" class="mb-2 block">Organization URL</label>
                                <input id="orgUrl" type="text" pInputText [(ngModel)]="orgUrl" name="orgUrl" class="w-full" />
                            </div>
                            <div class="field col-12 md:col-4">
                                <label for="orgType" class="mb-2 block">Organization Type</label>
                                <p-dropdown inputId="orgType" [options]="organizationTypes" [(ngModel)]="selectedOrgType"
                                    placeholder="Select Type" optionLabel="label" optionValue="value" name="orgType" class="w-full"></p-dropdown>
                            </div>
                            <div class="field col-12 md:col-3">
                                <label for="city" class="mb-2 block">City</label>
                                <input id="city" type="text" pInputText [(ngModel)]="city" name="city" class="w-full" />
                            </div>
                            <div class="field col-12 md:col-3">
                                <label for="state" class="mb-2 block">State</label>
                                <input id="state" type="text" pInputText [(ngModel)]="state" name="state" class="w-full" />
                            </div>
                            <div class="field col-12 md:col-4">
                                <label for="estDate" class="mb-2 block">Establishment Date</label>
                                <p-calendar id="estDate" [(ngModel)]="establishDate" dateFormat="dd/mm/yy" name="estDate"
                                    class="w-full"></p-calendar>
                            </div>
                            <div class="field col-12 md:col-3">
                                <label for="subscription" class="mb-2 block">Subscription Type</label>
                                <p-dropdown inputId="subscription" [options]="subscriptionTypes" name="subscription"
                                    [(ngModel)]="selectedSubscription" placeholder="Select Subscription" class="w-full"></p-dropdown>
                            </div>

                            <!-- Owner Section -->
                            <div class="col-12">
                                <h5 class="mt-3 mb-2 border-bottom-1 surface-border pb-2 font-semibold text-lg">Owner Details</h5>
                            </div>
                            <div class="field col-12 md:col-3">
                                <label for="ownerName" class="mb-2 block">Owner Name</label>
                                <input id="ownerName" type="text" pInputText [(ngModel)]="ownerName" name="ownerName" class="w-full" />
                            </div>
                            <div class="field col-12 md:col-3">
                                <label for="ownerEmail" class="mb-2 block">Owner Email</label>
                                <input id="ownerEmail" type="email" pInputText [(ngModel)]="ownerEmail" name="ownerEmail" class="w-full" required />
                            </div>
                            <div class="field col-12 md:col-3">
                                <label for="ownerMobile" class="mb-2 block">Owner Mobile</label>
                                <input id="ownerMobile" type="text" pInputText [(ngModel)]="ownerMobile" name="ownerMobile" class="w-full" />
                            </div>

                            <div class="col-12 mt-4">
                                <div class="flex gap-3">
                                    <!-- This button now triggers the form's (ngSubmit) event -->
                                    <button pButton [label]="isEditing ? 'Update' : 'Submit'" class="p-button-success" type="submit"></button>
                                    <button pButton label="Cancel" class="p-button-secondary" type="button" (click)="resetForm()"></button>
                                </div>
                            </div>
                        </div>
                    </form>
                </p-tabpanel>

                <p-tabpanel value="1">
                    <p-table [value]="organizations" [paginator]="true" [rows]="5" responsiveLayout="scroll"
                        [showCurrentPageReport]="true"
                        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
                        class="p-datatable-sm">
                        <ng-template pTemplate="header">
                            <tr>
                                <th>Organization Name</th>
                                <th>Brand Name</th>
                                <th>URL</th>
                                <th>Type</th>
                                <th>City</th>
                                <th>State</th>
                                <th>Est. Date</th>
                                <th>Owner Name</th>
                                <th>Owner Email</th>
                                <th>Owner Mobile</th>
                                <th>Actions</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-org>
                            <tr>
                                <td>{{ org.orgName }}</td>
                                <td>{{ org.brandName }}</td>
                                <td>{{ org.orgUrl }}</td>
                                <td>{{ org.orgType }}</td>
                                <td>{{ org.city }}</td>
                                <td>{{ org.state }}</td>
                                <td>{{ org.establishDate | date: 'dd/MM/yyyy' }}</td>
                                <td>{{ org.ownerName }}</td>
                                <td>{{ org.ownerEmail }}</td>
                                <td>{{ org.ownerMobile }}</td>
                                <td>
                                    <div class="flex gap-2">
                                        <button pButton icon="pi pi-pencil"
                                            class="p-button-rounded p-button-warning p-button-sm"
                                            (click)="editOrganization(org)" pTooltip="Edit">
                                        </button>
                                        <button pButton icon="pi pi-trash"
                                            class="p-button-rounded p-button-danger p-button-sm"
                                            (click)="deleteOrganization(org)" pTooltip="Delete">
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </p-tabpanel>
            </p-tabpanels>
        </p-tabs>
    </p-card>
    

    <p-dialog header="Edit Organization" [(visible)]="displayEditDialog" [modal]="true" 
              [style]="{width: '60vw'}" (onHide)="handleUpdateComplete(false)">
     
        <app-edit-organization 
            *ngIf="selectedOrgForEdit" 
            [organization]="selectedOrgForEdit" 
            (updateComplete)="handleUpdateComplete($event)">
        </app-edit-organization>
    </p-dialog>


</div>

